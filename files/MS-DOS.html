<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .background {
        background-color: black;
        color: lime;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
    }

    #textarea {
        background-color: transparent;
        border: none;
        width: 100%;
        height: calc(100% - 40px); 
        resize: none;               
        color: white;
    }

    #textarea:focus {
        outline: none;
    }
</style>
<body>
    <textarea name="terminal" id="textarea" cols="30" rows="30"></textarea>
    <script>
        const terminal = document.getElementById("textarea");
        const prompt = 'C:\\DOS > ';
        terminal.value += prompt;

        // Focus the terminal on page load
        window.onload = function() {
            terminal.focus();
            terminal.selectionStart = terminal.value.length;
            terminal.selectionEnd = terminal.value.length;
        };

        
        const commands = {
            math: (args) => `${args}`,
            help: () => `Available commands:
            - help\t\t List all available commands
            - ls\t\t\t List the files in the directory
            - math\t\t Solve mathematical expressions
            - clear\t\t Clear the console`,
            ls: () => 'Projects \t MS-DOS \t Icon 3',
            clear: () => { 
                terminal.value = prompt; 
                return null;
            },
        };

        function runCommand(command) {
            command = command.trim();

            // Dynamic commands
            if (command.startsWith('math ')) {
                const math_expression = command.slice(4);
                return `Output: ${eval(math_expression)}`;
            }

            // Static commands
            if (commands[command]) {
                return commands[command]();
            }

            // Empty input
            if (command === '') return '';

            // Unknown command
            return `Bad command or file name: ${command}`;
        }

        let commandStack = [];
        let commandStackIdx = 0;

        document.addEventListener('keydown', function(event) {           
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();

                if (commandStack.length > 0 && commandStackIdx < commandStack.length) {
                    commandStackIdx++; // move deeper into history
                    console.log("ArrowUp idx:", commandStackIdx);

                    const prevCommand = commandStack[commandStack.length - commandStackIdx];
                    const lines = terminal.value.split('\n');
                    lines[lines.length - 1] = prompt + prevCommand;

                    terminal.value = lines.join('\n');
                }
            }

            if (event.key === 'ArrowDown') {
                event.preventDefault();

                if (commandStackIdx > 0) {
                    commandStackIdx--; // move back toward recent
                    console.log("ArrowDown idx:", commandStackIdx);

                    const prevCommand = commandStackIdx === 0 ? "" : commandStack[commandStack.length - commandStackIdx];

                    const lines = terminal.value.split('\n');
                    lines[lines.length - 1] = prompt + prevCommand;

                    terminal.value = lines.join('\n');
                }
            }


            if (event.key === 'ArrowLeft' || event.key === 'Backspace' || event.key === 'Home') {
                              
                const cursorPosition = terminal.selectionStart;
                const lines = terminal.value.split('\n');
                const lastLineStart = terminal.value.lastIndexOf("\n") + 1;

                const PROMPT_LENGTH = prompt.length + 1;

                if (cursorPosition < lastLineStart + PROMPT_LENGTH) {
                    event.preventDefault();

                    terminal.selectionStart = terminal.selectionEnd = lastLineStart + PROMPT_LENGTH;
                }

            }

            if (event.key === 'Enter') {
                event.preventDefault();

                const lines = terminal.value.split('\n');
                const lastLine = lines[lines.length - 1];
                const command = lastLine.replace(prompt, '').trim().toLowerCase();

                commandStack.push(command);
                console.log(commandStack);

                let output = runCommand(command);
                commandStackIdx = 0; // Resetting the commandStackIdx each time a command is run
                
                if (output != null){
                    // Append output and a new prompt to the terminal
                    terminal.value += '\n' + output + '\n' + prompt;

                    // Auto-scroll to the bottom
                    terminal.scrollTop = terminal.scrollHeight;
                }
                
                
            }
        });
    </script>
</body>
</html>